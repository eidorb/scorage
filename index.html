<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Scorage</title>
  <link href="//fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link type="text/css" rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/materialize/0.97.6/css/materialize.min.css"  media="screen,projection"/>
  <style type="text/css">
    html {
      font-family: sans-serif;
    }

    /* Adjust z-index so that nav shadows are shown on tabs. */
    nav {
      position: relative;
      z-index: 1;
    }

    .row {
      overflow: auto;
    }

    table {
      width: initial;
    }

    /* Bottom border after each round. */
    table > tbody > tr:nth-child(3n+0) {
      border-bottom: 1px solid #d0d0d0;
    }

    /* Center row headers too. */
    table.centered tbody tr th {
      text-align: center;
    }

    table tbody th[rowspan] {
      padding-right: 1em;
    }

    table input[type=number] {
      text-align: center;
      width: 2rem;
      height: 1.5rem;
      margin: 0;
    }

    table th .chip {
      text-transform: uppercase;
      font-weight: inherit;
    }

    td, th {
      padding-top: 0.5rem;
      padding-bottom: 0.5rem;
    }

    input[type=text] {
      width: 10rem;
    }

    /* Remove Webkit spinners. */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    select.browser-default {
      width: inherit;
    }

    /* Space buttons a bit. */
    .input-field button:not(:first-child) {
      margin-left: 1rem;
    }
  </style>
</head>

<body>

  <nav>
    <div class="nav-wrapper container">
      <a class="brand-logo center" href="javascript:;">Scorage</a>
    </div>
  </nav>

  <div id="ractive-container"></div>

  <script id="template" type="text/ractive">

    <ul class="tabs">
      <li class="tab"><a href="javascript:;" class="{{ (view === 'score') ? 'active' : '' }}" on-click="set('view', 'score')">Scores</a></li>
      <li class="tab"><a href="javascript:;" class="{{ (view === 'setup') ? 'active' : '' }}" on-click="set('view', 'setup')">Setup</a></li>
    </ul>

    <div class="container">
      {{ #(view === 'score') }}
      <div class="row">
        <div class="col">
          <table class="centered">
            <thead>
              <tr>
                <th colspan="2">Round</th>

                {{ #each shortenedNames }}
                <th><div class="chip">{{ this }}</div></th>
                {{ /each }}

                <th>&Sigma;</th>
              </tr>
            </thead>

            {{ #createTable() }}
            <tbody>
              {{ #each rounds: round }}
              <tr>
                <th rowspan="3">{{ round + 1 }}</th>
                <th>Bids</th>

                {{ #each bids: index }}
                <td><input type="number" value="{{ this === null ? '' : this }}" on-input="editBid: {{ round }}, {{ index }}" twoway="false" class="browser-default number-input"></td>
                {{ /each }}

                <td>{{ totalBids }}</td>

                {{ #if(round && (round == numRounds - 1)) }}
                <td rowspan="3"><button type="button" class="waves-effect waves-light btn red" on-click="removeRound: {{ round }}"><i class="material-icons left">remove_circle</i>Remove Round</button></td>
                {{ /if }}
              </tr>

              <tr>
                <th>Tricks</th>

                {{ #each tricks: index }}
                <td><input type="number" value="{{ this === null ? '' : this }}" on-input="editTrick: {{ round }}, {{ index }}" twoway="false" class="number-input"></td>
                {{ /each }}

                <td>{{ totalTricks }}</td>
              </tr>

              <tr>
                <th>Points</th>

                {{ #each points: index }}
                <td>
                  {{ # !(this === null) }}
                  <span class="{{ (this > 0) ? 'green-text text-darken-1' : 'red-text text-darken-1'}}"><strong>{{ (this > 0) ? '+' + this : this }}</strong></span>
                  {{ / }}
                </td>
                {{ /each }}
              </tr>
              {{ /each }}

              <tr>
                <th colspan="2">Scores</th>

                {{ #each scores }}
                <td>{{ this }}</td>
                {{ /each }}
              </tr>
            </tbody>
            {{ /createTable }}
          </table>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <div class="input-field">
            <button type="button" class="waves-effect waves-light btn green" on-click="addRound"><i class="material-icons left">add_circle</i>Add Round</button>
            <button type="button" class="waves-effect waves-light btn red" on-click="removeAllRounds"><i class="material-icons left">delete_forever</i>Remove All Rounds</button>
          </div>
        </div>
      </div>
      {{ /(view === 'score') }}


      {{ #(view === 'setup') }}
      <div class="row">
        <div class="col s12 m6">
          <h4>Player names</h4>

          {{ #each players: index }}
          <div class="input-field">
            <input type="text" placeholder="Player name" value="{{ name }}" on-input="editPlayerName: {{ index }}" twoway="false">

            {{ #if players.length > 1 }}
            <button type="button" class="waves-effect waves-light btn red" on-click="removePlayer: {{ index }}"><i class="material-icons">remove_circle</i></button>
            {{ /if }}
          </div>
          {{ /each}}

          <div class="input-field">
            <input id="new-player-name" type="text" on-change="addPlayer">
            <label for="new-player-name">New player name</label>
          </div>
        </div>

        <div class="col s12 m6">
          <h4>Rules</h4>

          <div class="input-field">
            <select class="browser-default" value="{{ rules }}">
              {{ #each ruleSets: id }}
              <option value="{{ id }}">{{ name }}</option>
              {{ /each }}
            </select>
          </div>

          <ul class="browser-default">
            {{ #each ruleSets[rules].details }}
            <li>{{ this }}</li>
            {{ /each }}
          </ul>
        </div>
      </div>
      {{ /(view === 'setup') }}
    </div>
  </script>

  <script src="//cdnjs.cloudflare.com/ajax/libs/ractive/0.7.3/ractive.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/store.js/1.3.20/store.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.3/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/materialize/0.97.6/js/materialize.min.js"></script>

  <script>
    Ractive.DEBUG = false;

    // Retrieve data from local storage if present.
    var players = store.get('players');
    var rules = store.get('rules');
    var view = store.get('view');
    if (!players) {
      console.log('No players in storage, using defaults.');
      players = [{
        name: 'Player 1',
        bids: [null],
        tricks: [null]
      }];
    }
    if (!rules) {
      console.log('No rules in storage, using default rules.');
      rules = 'shing';
    }
    if (!view) {
      console.log('No view in storage, using default view.');
      view = 'setup';
    }

    var ractive = new Ractive({
      el: '#ractive-container',

      template: '#template',

      data: {
        view: view,

        players: players,

        rules: rules,

        ruleSets: {
          regular: {
            name: 'Regular',
            details: [
              '+1 point for each trick',
              '+10 points for taking the exact number of tricks bid (for non-zero bids)',
              '+5 points for taking zero tricks (for bids of zero)',
            ],
            scoreFunc: function(round, bid, tricks) {
              // Avoid implicit conversion of null to 0.
              if (bid === null || tricks === null) {
                return null;
              }
              if (bid === tricks) {
                if (bid > 0) {
                  return tricks + 10;
                } else {
                  return tricks + 5;
                }
              } else {
                return tricks;
              }
            }
          },
          alternate: {
            name: 'Alternate',
            details: [
              '+1 point for each trick',
              '+10 points for taking the exact number of tricks bid (including bids of zero)',
              '-5 points for missing your bid',
            ],
            scoreFunc: function(round, bid, tricks) {
              // Avoid implicit conversion of null to 0.
              if (bid === null || tricks === null) {
                return null;
              }
              if (bid === tricks) {
                return tricks + 10;
              } else {
                return tricks - 5;
              }
            }
          },
          shing: {
            name: "Shing's house rules",
            details: [
              '+1 point for each trick',
              '+10 points for taking the exact number of tricks bid (for non-zero bids)',
              'The greater of 5 points or the round number for taking zero tricks (for bids of zero)',
              '-5 points for missing your bid',
            ],
            scoreFunc: function(round, bid, tricks) {
              // Avoid implicit conversion of null to 0.
              if (bid === null || tricks === null) {
                return null;
              }
              if (bid === tricks) {
                if (bid > 0) {
                  return tricks + 10;
                } else {
                  // Successful zero bids get points equal to the maximum of 5
                  // or the current round number.
                  var points;
                  if ((round + 1) > 5) {
                    points = round + 1;
                  } else {
                    points = 5;
                  }
                  return points;
                }
              } else {
                return tricks - 5;
              }
            }
          }
        },

        // Compute data for the table.
        createTable: function() {
          var players = this.get('players');
          var numRounds = this.get('numRounds');
          var calcPoints = this.get('ruleSets')[this.get('rules')].scoreFunc;
          var table = {};
          table.rounds = [];
          table.scores = [];
          // The total score for each player is initially set to zero.
          table.scores = players.map(function() {return 0});
          // Create player-wise bids, tricks and points for each round.
          for (var round = 0; round < numRounds; round++) {
            var bids = [];
            var tricks = [];
            var pointsArray = [];
            var totalBids = 0;
            var totalTricks = 0;
            // Retrieve each player's bid and tricks for the round and calculate points.
            for (var index = 0; index < players.length; index++) {
              var bid = players[index].bids[round];
              var trick = players[index].tricks[round];
              var points = calcPoints(round, bid, trick);
              bids.push(bid);
              tricks.push(trick);
              pointsArray.push(points);
              // Add points to the player's score (null points will be converted
              // to 0 - not a drama).
              table.scores[index] += points;
              totalBids += bid;
              totalTricks += trick;
            }
            table.rounds.push({
              bids: bids,
              tricks: tricks,
              points: pointsArray,
              totalBids: totalBids,
              totalTricks: totalTricks,
            });
          }
          return table;
        }
      },

      computed: {
        playerNames: function() {
          return this.get('players').map(function(player) {
            return player.name;
          });
        },

        shortenedNames: function() {
          return uniquePrefixes(this.get('playerNames'));
        },

        // Number of rounds, calculated from the first player's bids.
        numRounds: function() {
          return this.get('players')[0].bids.length;
        }
      }
    });

    ractive.on({
      addPlayer: function(event) {
        // The new player's bids and tricks arrays are filled with as many nulls
        // as there are rounds.
        var numRounds = this.get('numRounds');
        var bids = [];
        for (var i = 0; i < numRounds; i++) {
          bids.push(null);
        }
        // Tricks is a copy of bids.
        var tricks = bids.slice();
        this.push('players', {
          name: event.node.value.trim(),
          bids: bids,
          tricks: tricks
        });
        // Clear the new player input.
        event.node.value = '';
      },

      removePlayer: function(event, index) {
        this.splice('players', index, 1);
      },

      editPlayerName: function(event, index) {
        this.set('players[' + index + '].name', event.node.value.trim());
      },

      editBid: function(event, round, index) {
        var parsed = parseString(event.node.value.trim());
        this.set('players[' + index + '].bids[' + round + ']', parsed);
      },

      editTrick: function(event, round, index) {
        var parsed = parseString(event.node.value.trim());
        this.set('players[' + index + '].tricks[' + round + ']', parsed);
      },

      addRound: function(event) {
        // Adding a round pushes a null on to all players' bids and tricks arrays.
        for (var index = 0; index < this.get('players').length; index++) {
          this.push('players[' + index + '].bids', null);
          this.push('players[' + index + '].tricks', null);
        }
      },

      removeRound: function(event, round) {
        for (var index = 0; index < this.get('players').length; index++) {
          this.splice('players[' + index + '].bids', round, 1);
          this.splice('players[' + index + '].tricks', round, 1);
        }
      },

      removeAllRounds: function(event) {
        // Set all player's bids and tricks arrays to an array with a single null.
        for (var index = 0; index < this.get('players').length; index++) {
          this.set('players[' + index + '].bids', [null]);
          this.set('players[' + index + '].tricks', [null]);
        }
      }
    });

    // If storage is enabled, observe for change and write to storage.
    if (store.enabled) {
      ractive.observe({
        players: function() {
          store.set('players', this.get('players'));
        },

        rules: function() {
          store.set('rules', this.get('rules'));
        },

        view: function() {
          store.set('view', this.get('view'));
        }
      }, {
        // Don't call the functions initially.
        init: false
      });
    }

    // Return the shortest unique prefixes from an array of strings.
    function uniquePrefixes(strings) {
      return strings.map(function(string, index, strings) {
        // Create incrementally longer prefixes of string.
        for (var prefixLength = 1; prefixLength <= string.length; prefixLength++) {
          // Uniqueness flag initially set true.
          var unique = true;
          // Create a prefix which increases in length each iteration.
          var prefix = string.substr(0, prefixLength);
          // Compare prefix to the same length prefix of each other string.
          for (var stringIndex = 0; stringIndex < strings.length; stringIndex++) {
            // Don't compare a prefixes of the same string.
            if (index === stringIndex) {
              continue;
            }
            var comparisonPrefix = strings[stringIndex].substr(0, prefixLength);
            // If a match is found, then the prefix is not unique. Do not
            // bother comparing the prefix with the remaining strings.
            if (prefix.toLowerCase() === comparisonPrefix.toLowerCase()) {
              unique = false;
              break;
            }
          }
          // Prefixes have been compared, return the prefix if unique.
          if (unique === true) {
            return prefix;
          }
        }
        // If no unique prefix was found, just return the string.
        return string;
      });
    }

    // Return a parsed base-10 integer or null if parse result was NaN.
    function parseString(string) {
      var parsed = parseInt(string, 10);
      return isNaN(parsed) ? null : parsed;
    }
  </script>
</body>
</html>
